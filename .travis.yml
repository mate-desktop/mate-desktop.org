# vim: set ts=2 sts=2 sw=2 expandtab :
dist: xenial
sudo: required
language: bash
services:
  - docker

before_install:
  - curl -Ls -o docker-build https://github.com/mate-desktop/mate-dev-scripts/raw/master/travis/docker-build
  - chmod +x docker-build

install:
  - sudo apt-get install -y python3-pip python3-setuptools
  - sudo pip3 install --upgrade pip
  - sudo pip install PyGithub
  - ./docker-build --name ${DISTRO} --config .travis.yml --install

script:
  - ./docker-build --name ${DISTRO} --verbose --config .travis.yml --build scripts

deploy:
  provider: script
  script: ./docker-build --verbose --config .travis.yml --release
  skip_cleanup: true
  on:
    tags: true
    condition: "${TRAVIS_TAG} =~ ^v.*$ && ${DISTRO} =~ ^archlinux.*$"

env:
  - DISTRO="archlinux/base"

##########################################################
# THE FOLLOWING LINES IS USED BY docker-build
##########################################################
requires:
  archlinux:
    - nikola
    - tar
    - fakeroot
    - java-runtime-headless
    - python-typogrify
    - optipng
    - jpegoptim
    - java-runtime=8
    - unzip

before_scripts:
  - cd ${START_DIR}
  - mkdir -p yui-compressor-builds
  - cd yui-compressor-builds
  - if [ ! -f yuicompressor-2.4.8.jar ];then
  -     curl -Ls -o yuicompressor-2.4.8.jar https://github.com/yui/yuicompressor/releases/download/v2.4.8/yuicompressor-2.4.8.jar
  -     curl -Ls -o yuicompressor.sh https://aur.archlinux.org/cgit/aur.git/plain/yuicompressor.sh?h=yuicompressor
  -     sed -i "s|x\.y\.z|2.4.8|" yuicompressor.sh
  -     install -D -m644  yuicompressor-2.4.8.jar /usr/share/java/yuicompressor-2.4.8.jar
  -     install -D -m755  yuicompressor.sh /usr/bin/yuicompressor
  - fi

  - cd ${START_DIR}
  - mkdir -p closure-compiler-builds
  - cd closure-compiler-builds
  - if [ ! -f compiler-latest.zip ];then
  -     curl -Ls -o compiler-latest.zip https://dl.google.com/closure-compiler/compiler-latest.zip
  -     unzip compiler-latest.zip
  -     install -Dm644 closure-compiler-v*.jar /usr/share/java/closure-compiler/closure-compiler.jar
  -     echo "#!/bin/sh" > /usr/bin/closure-compiler
  -     echo 'PATH="/usr/lib/jvm/java-8-openjdk/bin:$PATH" java -jar /usr/share/java/closure-compiler/closure-compiler.jar $@' >> /usr/bin/closure-compiler
  -     chmod +x /usr/bin/closure-compiler
  - fi

build_scripts:
  - nikola build

after_scripts:
  - cd ${START_DIR}
  - tarballs=website-`date +%y.%m.%d`-tar.xz
  - if [ -f ${tarballs} ];then
  -     rm -rf ${tarballs}
  - fi
  - mv output www
  - tar Jcf ../website-`date +%y.%m.%d`-tar.xz www

releases:
  draft: False
  prerelease: False
  checksum: True
  overwrite: True
  base_version: 18.2.7
  file_glob: True
  files: website-*.tar.xz
  #custom_http_headers:
  #  - "User-Agent = release-bot/0.1.1 (Travis CI)"
  #  - Release-Token = $SERVER_POST_TOKEN
  #servers:
  #  - http://pub.mate-desktop.org/releases/
